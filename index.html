<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SoroMarket ‚Äì 2028 US Election Prediction Markets</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/12.2.0/stellar-sdk.min.js"></script>
</head>
<body>
<div class="container">
  <header>
    <h1>SoroMarket</h1>
    <p class="subheading">DECENTRALIZED PREDICTION MARKETS ON STELLAR</p>
    <p class="subtitle">‚Ä¢ 2028 US Presidential Election ‚Ä¢</p>
    <div class="wallet-info" id="walletInfo">
      <span>Connecting wallet...</span>
    </div>
  </header>

  <div id="messageContainer"></div>

  <div class="markets-grid" id="marketsGrid">
    <!-- JD Vance -->
    <div class="market-card" data-candidate="jd-vance">
      <div class="candidate-name">JD Vance</div>
      <div class="candidate-party">Republican Party</div>
      
      <div class="market-stats">
        <div class="stat">
          <div class="stat-label">Current Price</div>
          <div class="stat-value probability" id="vance-probability">...%</div>
        </div>
        <div class="stat">
          <div class="stat-label">Total Volume</div>
          <div class="stat-value" id="vance-volume">$0</div>
        </div>
      </div>

      <div class="betting-section">
        <div class="bet-inputs">
          <div class="bet-input-group">
            <label>Amount (USDC)</label>
            <input type="number" id="vance-amount" placeholder="10" min="1" step="1">
          </div>
          <div class="bet-input-group">
            <label>Expected Shares</label>
            <input type="text" id="vance-shares" readonly placeholder="0">
          </div>
        </div>
        
        <div class="bet-buttons">
          <button class="btn btn-yes" onclick="placeBet('vance', true)">
            Buy YES <span id="vance-yes-price">$...</span>
          </button>
          <button class="btn btn-no" onclick="placeBet('vance', false)">
            Buy NO <span id="vance-no-price">$...</span>
          </button>
        </div>

        <div class="user-position">
          <div class="shares-balance">
            <div class="balance-item">
              <span class="balance-label">Your YES shares:</span>
              <span class="balance-value" id="vance-yes-balance">0</span>
            </div>
            <div class="balance-item">
              <span class="balance-label">Your NO shares:</span>
              <span class="balance-value" id="vance-no-balance">0</span>
            </div>
          </div>
          <button class="btn btn-claim" id="vance-claim-btn" onclick="claimWinnings('vance')" disabled>
            Claim Winnings
          </button>
        </div>
      </div>
    </div>

    <!-- Gavin Newsom -->
    <div class="market-card" data-candidate="gavin-newsom">
      <div class="candidate-name">Gavin Newsom</div>
      <div class="candidate-party">Democratic Party</div>
      
      <div class="market-stats">
        <div class="stat">
          <div class="stat-label">Current Price</div>
          <div class="stat-value probability" id="newsom-probability">...%</div>
        </div>
        <div class="stat">
          <div class="stat-label">Total Volume</div>
          <div class="stat-value" id="newsom-volume">$0</div>
        </div>
      </div>

      <div class="betting-section">
        <div class="bet-inputs">
          <div class="bet-input-group">
            <label>Amount (USDC)</label>
            <input type="number" id="newsom-amount" placeholder="10" min="1" step="1">
          </div>
          <div class="bet-input-group">
            <label>Expected Shares</label>
            <input type="text" id="newsom-shares" readonly placeholder="0">
          </div>
        </div>
        
        <div class="bet-buttons">
          <button class="btn btn-yes" onclick="placeBet('newsom', true)">
            Buy YES <span id="newsom-yes-price">$...</span>
          </button>
          <button class="btn btn-no" onclick="placeBet('newsom', false)">
            Buy NO <span id="newsom-no-price">$...</span>
          </button>
        </div>

        <div class="user-position">
          <div class="shares-balance">
            <div class="balance-item">
              <span class="balance-label">Your YES shares:</span>
              <span class="balance-value" id="newsom-yes-balance">0</span>
            </div>
            <div class="balance-item">
              <span class="balance-label">Your NO shares:</span>
              <span class="balance-value" id="newsom-no-balance">0</span>
            </div>
          </div>
          <button class="btn btn-claim" id="newsom-claim-btn" onclick="claimWinnings('newsom')" disabled>
            Claim Winnings
          </button>
        </div>
      </div>
    </div>

    <!-- Alexandria Ocasio-Cortez -->
    <div class="market-card" data-candidate="aoc">
      <div class="candidate-name">Alexandria Ocasio-Cortez</div>
      <div class="candidate-party">Democratic Party</div>
      
      <div class="market-stats">
        <div class="stat">
          <div class="stat-label">Current Price</div>
          <div class="stat-value probability" id="aoc-probability">...%</div>
        </div>
        <div class="stat">
          <div class="stat-label">Total Volume</div>
          <div class="stat-value" id="aoc-volume">$0</div>
        </div>
      </div>

      <div class="betting-section">
        <div class="bet-inputs">
          <div class="bet-input-group">
            <label>Amount (USDC)</label>
            <input type="number" id="aoc-amount" placeholder="10" min="1" step="1">
          </div>
          <div class="bet-input-group">
            <label>Expected Shares</label>
            <input type="text" id="aoc-shares" readonly placeholder="0">
          </div>
        </div>
        
        <div class="bet-buttons">
          <button class="btn btn-yes" onclick="placeBet('aoc', true)">
            Buy YES <span id="aoc-yes-price">$...</span>
          </button>
          <button class="btn btn-no" onclick="placeBet('aoc', false)">
            Buy NO <span id="aoc-no-price">$...</span>
          </button>
        </div>

        <div class="user-position">
          <div class="shares-balance">
            <div class="balance-item">
              <span class="balance-label">Your YES shares:</span>
              <span class="balance-value" id="aoc-yes-balance">0</span>
            </div>
            <div class="balance-item">
              <span class="balance-label">Your NO shares:</span>
              <span class="balance-value" id="aoc-no-balance">0</span>
            </div>
          </div>
          <button class="btn btn-claim" id="aoc-claim-btn" onclick="claimWinnings('aoc')" disabled>
            Claim Winnings
          </button>
        </div>
      </div>
    </div>

    <!-- Pete Buttigieg -->
    <div class="market-card" data-candidate="buttigieg">
      <div class="candidate-name">Pete Buttigieg</div>
      <div class="candidate-party">Democratic Party</div>
      
      <div class="market-stats">
        <div class="stat">
          <div class="stat-label">Current Price</div>
          <div class="stat-value probability" id="buttigieg-probability">...%</div>
        </div>
        <div class="stat">
          <div class="stat-label">Total Volume</div>
          <div class="stat-value" id="buttigieg-volume">$0</div>
        </div>
      </div>

      <div class="betting-section">
        <div class="bet-inputs">
          <div class="bet-input-group">
            <label>Amount (USDC)</label>
            <input type="number" id="buttigieg-amount" placeholder="10" min="1" step="1">
          </div>
          <div class="bet-input-group">
            <label>Expected Shares</label>
            <input type="text" id="buttigieg-shares" readonly placeholder="0">
          </div>
        </div>
        
        <div class="bet-buttons">
          <button class="btn btn-yes" onclick="placeBet('buttigieg', true)">
            Buy YES <span id="buttigieg-yes-price">$...</span>
          </button>
          <button class="btn btn-no" onclick="placeBet('buttigieg', false)">
            Buy NO <span id="buttigieg-no-price">$...</span>
          </button>
        </div>

        <div class="user-position">
          <div class="shares-balance">
            <div class="balance-item">
              <span class="balance-label">Your YES shares:</span>
              <span class="balance-value" id="buttigieg-yes-balance">0</span>
            </div>
            <div class="balance-item">
              <span class="balance-label">Your NO shares:</span>
              <span class="balance-value" id="buttigieg-no-balance">0</span>
            </div>
          </div>
          <button class="btn btn-claim" id="buttigieg-claim-btn" onclick="claimWinnings('buttigieg')" disabled>
            Claim Winnings
          </button>
        </div>
      </div>
    </div>

    <!-- Marco Rubio -->
    <div class="market-card" data-candidate="rubio">
      <div class="candidate-name">Marco Rubio</div>
      <div class="candidate-party">Republican Party</div>
      
      <div class="market-stats">
        <div class="stat">
          <div class="stat-label">Current Price</div>
          <div class="stat-value probability" id="rubio-probability">...%</div>
        </div>
        <div class="stat">
          <div class="stat-label">Total Volume</div>
          <div class="stat-value" id="rubio-volume">$0</div>
        </div>
      </div>

      <div class="betting-section">
        <div class="bet-inputs">
          <div class="bet-input-group">
            <label>Amount (USDC)</label>
            <input type="number" id="rubio-amount" placeholder="10" min="1" step="1">
          </div>
          <div class="bet-input-group">
            <label>Expected Shares</label>
            <input type="text" id="rubio-shares" readonly placeholder="0">
          </div>
        </div>
        
        <div class="bet-buttons">
          <button class="btn btn-yes" onclick="placeBet('rubio', true)">
            Buy YES <span id="rubio-yes-price">$...</span>
          </button>
          <button class="btn btn-no" onclick="placeBet('rubio', false)">
            Buy NO <span id="rubio-no-price">$...</span>
          </button>
        </div>

        <div class="user-position">
          <div class="shares-balance">
            <div class="balance-item">
              <span class="balance-label">Your YES shares:</span>
              <span class="balance-value" id="rubio-yes-balance">0</span>
            </div>
            <div class="balance-item">
              <span class="balance-label">Your NO shares:</span>
              <span class="balance-value" id="rubio-no-balance">0</span>
            </div>
          </div>
          <button class="btn btn-claim" id="rubio-claim-btn" onclick="claimWinnings('rubio')" disabled>
            Claim Winnings
          </button>
        </div>
      </div>
    </div>

    <!-- Andy Beshear -->
    <div class="market-card" data-candidate="beshear">
      <div class="candidate-name">Andy Beshear</div>
      <div class="candidate-party">Democratic Party</div>
      
      <div class="market-stats">
        <div class="stat">
          <div class="stat-label">Current Price</div>
          <div class="stat-value probability" id="beshear-probability">...%</div>
        </div>
        <div class="stat">
          <div class="stat-label">Total Volume</div>
          <div class="stat-value" id="beshear-volume">$0</div>
        </div>
      </div>

      <div class="betting-section">
        <div class="bet-inputs">
          <div class="bet-input-group">
            <label>Amount (USDC)</label>
            <input type="number" id="beshear-amount" placeholder="10" min="1" step="1">
          </div>
          <div class="bet-input-group">
            <label>Expected Shares</label>
            <input type="text" id="beshear-shares" readonly placeholder="0">
          </div>
        </div>
        
        <div class="bet-buttons">
          <button class="btn btn-yes" onclick="placeBet('beshear', true)">
            Buy YES <span id="beshear-yes-price">$...</span>
          </button>
          <button class="btn btn-no" onclick="placeBet('beshear', false)">
            Buy NO <span id="beshear-no-price">$...</span>
          </button>
        </div>

        <div class="user-position">
          <div class="shares-balance">
            <div class="balance-item">
              <span class="balance-label">Your YES shares:</span>
              <span class="balance-value" id="beshear-yes-balance">0</span>
            </div>
            <div class="balance-item">
              <span class="balance-label">Your NO shares:</span>
              <span class="balance-value" id="beshear-no-balance">0</span>
            </div>
          </div>
          <button class="btn btn-claim" id="beshear-claim-btn" onclick="claimWinnings('beshear')" disabled>
            Claim Winnings
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>Powered by <a href="https://stellar.org/" target="_blank">Stellar</a></p>
    <p>‚Ä¢ Fair, transparent, decentralized ‚Ä¢</p>
  </footer>
</div>

<script>
// Configuration
const CONFIG = {
  rpcUrl: 'https://soroban-testnet.stellar.org',
  networkPassphrase: StellarSdk.Networks.TESTNET,
  contracts: {
    vance: 'CCDPI3WCXAX2AK3KFNQQXFTIM6FMDM2UEURFYK2TJ7752UMNCU3J4SIU',
    newsom: 'CBMV6V62S6AJLZPYEZAV5CLCDL4IOW2BO556WAQVVZYZY57Z4UVFBV6W', 
    aoc: 'CBWBCVM3ZMFMGSPW2K2BRPQ35FB5ADPUBIYD27XJYYAYAI6GNYFG3FI3',
    buttigieg: 'CBE7WCWNWEUMEHCZDUQD3RYY3XSYWGL5BN7OFSCBGLWYHMSIR3FAHY4T',
    rubio: 'CAOJMKJKHDWSMGQ6CNHYGT5PTVKLVPUIBO6YRSTTQOQAJGVGFQZQRCFK',
    beshear: 'CDI3OJD57SBZIZQNWLZ3XGLHNC3FUVMORTC3ZUV4L5NVENLXDMPM3YOB'
  },
  tokenContract: 'CBIELTK6YBZJU5UP2WWQEUCYKLPU6AUNZ2BQ4WWFEIE3USCIHMXQDAMA',
  liquidityParam: 500_000, // 50% liquidity parameter for LSMR
  refreshInterval: 30000 // 30 seconds
};

// Global variables
let rpc;
let keypair;
let isLoading = false;
let marketData = {
  vance: { trueShares: 0, falseShares: 0, trueTotal: 0, falseTotal: 0, state: null, probabilities: null, loaded: false },
  newsom: { trueShares: 0, falseShares: 0, trueTotal: 0, falseTotal: 0, state: null, probabilities: null, loaded: false },
  aoc: { trueShares: 0, falseShares: 0, trueTotal: 0, falseTotal: 0, state: null, probabilities: null, loaded: false },
  buttigieg: { trueShares: 0, falseShares: 0, trueTotal: 0, falseTotal: 0, state: null, probabilities: null, loaded: false },
  rubio: { trueShares: 0, falseShares: 0, trueTotal: 0, falseTotal: 0, state: null, probabilities: null, loaded: false },
  beshear: { trueShares: 0, falseShares: 0, trueTotal: 0, falseTotal: 0, state: null, probabilities: null, loaded: false }
};

// Track user positions
let userPositions = {
  vance: { yesShares: 0, noShares: 0, claimed: false },
  newsom: { yesShares: 0, noShares: 0, claimed: false },
  aoc: { yesShares: 0, noShares: 0, claimed: false },
  buttigieg: { yesShares: 0, noShares: 0, claimed: false },
  rubio: { yesShares: 0, noShares: 0, claimed: false },
  beshear: { yesShares: 0, noShares: 0, claimed: false }
};

// Market outcomes (for demo - in real app this comes from oracle)
let marketOutcomes = {
  vance: null,     // null = undecided, true = won, false = lost
  newsom: null,
  aoc: null,
  buttigieg: null,
  rubio: null,
  beshear: null
};

// Initialize app
(async function init() {
  try {
    showMessage('Initializing SoroMarket...', 'info');
    
    // Initialize Stellar SDK
    const RpcServer = StellarSdk.SorobanRpc?.Server || StellarSdk.rpc.Server;
    rpc = new RpcServer(CONFIG.rpcUrl);
    
    // Create and fund account
    keypair = await createFundedAccount();
    
    // Update wallet info
    updateWalletInfo();
    
    // Load market data
    await loadMarketData();
    
    // Set up event listeners
    setupEventListeners();
    
    // Update user balances
    updateAllUserBalances();
    
    // Start auto-refresh
    setInterval(() => {
      loadMarketData();
      updateAllUserBalances();
    }, CONFIG.refreshInterval);
    
    showMessage('Welcome to SoroMarket! Ready to trade 2028 election outcomes.', 'success');
    
  } catch (error) {
    console.error('Initialization error:', error);
    showMessage('Failed to initialize. Please refresh the page.', 'error');
  }
})();

// Create and fund a new account
async function createFundedAccount() {
  const kp = StellarSdk.Keypair.random();
  
  try {
    // Fund account using Friendbot
    await fetch(`https://friendbot.stellar.org/?addr=${kp.publicKey()}`);
    
    // Wait for funding to complete
    await new Promise(resolve => setTimeout(resolve, 5000));
    
    return kp;
  } catch (error) {
    throw new Error('Failed to create funded account');
  }
}

// Update wallet information display
function updateWalletInfo() {
  const walletInfo = document.getElementById('walletInfo');
  const publicKey = keypair.publicKey();
  walletInfo.innerHTML = `
    <strong>Wallet:</strong> ${publicKey.slice(0, 6)}...${publicKey.slice(-6)} 
    <span style="opacity: 0.7;">‚Ä¢ Stellar Testnet</span>
  `;
}

// Load market data for all candidates
async function loadMarketData() {
  try {
    // In a real implementation, you would call the actual contract methods
    // For demo purposes, we'll simulate market data with bonding curve logic
    
    await Promise.all([
      loadCandidateData('vance'),
      loadCandidateData('newsom'), 
      loadCandidateData('aoc'),
      loadCandidateData('buttigieg'),
      loadCandidateData('rubio'),
      loadCandidateData('beshear')
    ]);
    
    updateAllPrices();
    
  } catch (error) {
    console.error('Error loading market data:', error);
  }
}

// Load data for a specific candidate
async function loadCandidateData(candidate) {
  try {
    const contractAddress = CONFIG.contracts[candidate];
    
    // Real implementation using contract view functions
    const [marketInfo, probabilities, marketState] = await Promise.all([
      callContractMethod(contractAddress, 'get_market_info'),
      callContractMethod(contractAddress, 'get_current_probabilities'), 
      callContractMethod(contractAddress, 'get_market_state')
    ]);
    
    // marketInfo returns (trueShares, falseShares, trueTotal, falseTotal)
    marketData[candidate] = {
      trueShares: marketInfo[0] || 0,
      falseShares: marketInfo[1] || 0, 
      trueTotal: marketInfo[2] || 0,
      falseTotal: marketInfo[3] || 0,
      state: marketState,
      probabilities: probabilities, // (trueProbability, falseProbability)
      loaded: true
    };
    
  } catch (error) {
    console.error(`Error loading data for ${candidate}:`, error);
    
    // Keep loading state as false for error cases
    marketData[candidate] = {
      trueShares: 0,
      falseShares: 0,
      trueTotal: 0,
      falseTotal: 0,
      state: null,
      probabilities: null,
      loaded: false
    };
  }
}

// Calculate LSMR pricing for a candidate
function calculateLSMRPrice(candidate, betOnTrue, amount = 100) {
  const data = marketData[candidate];
  const totalShares = data.trueShares + data.falseShares;
  
  if (totalShares === 0) {
    return { yesPrice: 0.50, noPrice: 0.50, shares: amount };
  }
  
  const currentShares = betOnTrue ? data.trueShares : data.falseShares;
  const currentProb = currentShares / totalShares;
  
  // LSMR formula: price = currentProb + (1 - currentProb) * liquidityParam / SCALE
  const SCALE = 1_000_000;
  const liquidityParam = CONFIG.liquidityParam;
  const pricePerShare = currentProb + (1 - currentProb) * liquidityParam / SCALE;
  
  const yesPrice = betOnTrue ? pricePerShare : (1 - pricePerShare);
  const noPrice = 1 - yesPrice;
  
  // Calculate shares for given amount
  const shares = Math.floor(amount / (betOnTrue ? yesPrice : noPrice));
  
  return {
    yesPrice: Math.max(0.01, Math.min(0.99, yesPrice)),
    noPrice: Math.max(0.01, Math.min(0.99, noPrice)),
    shares: Math.max(1, shares)
  };
}

// Update all price displays
function updateAllPrices() {
  ['vance', 'newsom', 'aoc', 'buttigieg', 'rubio', 'beshear'].forEach(candidate => {
    updateCandidatePrices(candidate);
  });
}

// Update prices for a specific candidate
function updateCandidatePrices(candidate) {
  const data = marketData[candidate];
  
  // Show loading state if data hasn't loaded yet
  if (!data.loaded) {
    document.getElementById(`${candidate}-probability`).textContent = '...%';
    document.getElementById(`${candidate}-volume`).textContent = '$0';
    document.getElementById(`${candidate}-yes-price`).textContent = '$...';
    document.getElementById(`${candidate}-no-price`).textContent = '$...';
    return;
  }
  
  // Use real probabilities from contract
  let yesPrice, noPrice;
  if (data.probabilities) {
    // Use actual contract probabilities (scaled to 0-1 from 1_000_000 scale)
    yesPrice = data.probabilities[0] / 1_000_000;
    noPrice = data.probabilities[1] / 1_000_000;
  } else {
    // Default to 50/50 if no probabilities available
    yesPrice = 0.5;
    noPrice = 0.5;
  }
  
  // Update probability display
  document.getElementById(`${candidate}-probability`).textContent = 
    `${(yesPrice * 100).toFixed(1)}%`;
  
  // Update volume display using real contract data only
  const totalVolume = (data.trueTotal || 0) + (data.falseTotal || 0);
  document.getElementById(`${candidate}-volume`).textContent = `$${Math.floor(totalVolume / 1_000_000).toLocaleString()}`;
  
  // Update button prices
  document.getElementById(`${candidate}-yes-price`).textContent = 
    `$${yesPrice.toFixed(2)}`;
  document.getElementById(`${candidate}-no-price`).textContent = 
    `$${noPrice.toFixed(2)}`;
  
  // Update shares calculation when amount changes
  updateSharesDisplay(candidate);
}

// Update expected shares display
async function updateSharesDisplay(candidate) {
  const amountInput = document.getElementById(`${candidate}-amount`);
  const sharesDisplay = document.getElementById(`${candidate}-shares`);
  
  const amount = parseFloat(amountInput.value) || 0;
  if (amount > 0 && marketData[candidate].loaded) {
    try {
      const contractAddress = CONFIG.contracts[candidate];
      // Use contract's get_shares_for_cost function for accurate calculation
      const shares = await callContractMethod(contractAddress, 'get_shares_for_cost', [
        amount * 1_000_000, // Convert to contract scale
        true // Default to YES for shares calculation
      ]);
      sharesDisplay.value = Math.floor(shares).toLocaleString();
    } catch (error) {
      // Show loading or error state
      sharesDisplay.value = '...';
    }
  } else {
    sharesDisplay.value = amount > 0 ? '...' : '0';
  }
}

// Set up event listeners
function setupEventListeners() {
  // Update shares display when amount changes
  ['vance', 'newsom', 'aoc', 'buttigieg', 'rubio', 'beshear'].forEach(candidate => {
    const amountInput = document.getElementById(`${candidate}-amount`);
    amountInput.addEventListener('input', () => updateSharesDisplay(candidate));
  });
}

// Place a bet
async function placeBet(candidate, betOnTrue) {
  if (isLoading) return;
  
  const amountInput = document.getElementById(`${candidate}-amount`);
  const amount = parseFloat(amountInput.value);
  
  if (!amount || amount < 1) {
    showMessage('Please enter a valid amount (minimum $1)', 'error');
    return;
  }
  
  try {
    isLoading = true;
    setLoadingState(candidate, true);
    
    showMessage(`Placing ${betOnTrue ? 'YES' : 'NO'} bet on ${getDisplayName(candidate)}...`, 'info');
    
    // Real implementation with contract calls
    const contractAddress = CONFIG.contracts[candidate];
    const scaledAmount = Math.floor(amount * 1_000_000); // Convert to contract scale
    
    // 1. Check token allowance and approve if needed
    const tokenContract = CONFIG.tokenContract;
    try {
      const allowance = await callContractMethod(tokenContract, 'allowance', [
        keypair.publicKey(),
        contractAddress
      ]);
      
      if (allowance < scaledAmount) {
        await callContractMethod(tokenContract, 'approve', [
          contractAddress,
          scaledAmount
        ], true); // Send real transaction for approval
        showMessage('Token approval confirmed...', 'info');
      }
    } catch (error) {
      console.warn('Token approval check failed, proceeding...', error);
    }
    
    // 2. Place the bet
    await callContractMethod(contractAddress, 'bet', [
      keypair.publicKey(),
      scaledAmount,
      betOnTrue
    ], true); // Send real transaction for bet
    
    // Clear input and refresh data from contract
    amountInput.value = '';
    await loadMarketData();
    await updateAllUserBalances();
    
    showMessage(
      `Successfully placed ${betOnTrue ? 'YES' : 'NO'} bet on ${getDisplayName(candidate)} for $${amount}!`, 
      'success'
    );
    
  } catch (error) {
    console.error('Betting error:', error);
    showMessage(`Failed to place bet: ${error.message}`, 'error');
  } finally {
    isLoading = false;
    setLoadingState(candidate, false);
  }
}

// Get display name for candidate
function getDisplayName(candidate) {
  const names = {
    'vance': 'JD Vance',
    'newsom': 'Gavin Newsom', 
    'aoc': 'Alexandria Ocasio-Cortez',
    'buttigieg': 'Pete Buttigieg',
    'rubio': 'Marco Rubio',
    'beshear': 'Andy Beshear'
  };
  return names[candidate] || candidate;
}

// Set loading state for candidate card
function setLoadingState(candidate, loading) {
  const card = document.querySelector(`[data-candidate="${candidate}"]`);
  const buttons = card.querySelectorAll('.btn');
  
  if (loading) {
    card.classList.add('loading');
    buttons.forEach(btn => {
      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.setAttribute('data-original-text', originalText);
      btn.innerHTML = '<span class="spinner"></span>';
    });
  } else {
    card.classList.remove('loading');
    buttons.forEach(btn => {
      btn.disabled = false;
      const originalText = btn.getAttribute('data-original-text');
      if (originalText) {
        btn.innerHTML = originalText;
      }
    });
  }
}

// Show message to user
function showMessage(text, type = 'info') {
  const container = document.getElementById('messageContainer');
  
  const messageEl = document.createElement('div');
  messageEl.className = `message ${type}`;
  messageEl.textContent = text;
  
  container.appendChild(messageEl);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (messageEl.parentNode) {
      messageEl.parentNode.removeChild(messageEl);
    }
  }, 5000);
}

// Contract method calls - simulate for view functions, send real tx for state changes
async function callContractMethod(contractAddress, method, params = [], sendTx = false) {
  try {
    const contract = new StellarSdk.Contract(contractAddress);
    const account = await rpc.getAccount(keypair.publicKey());
    
    // Convert parameters to Stellar SDK values
    const convertedParams = params.map(param => {
      if (typeof param === 'string') {
        // Check if it's an address (56 chars starting with G or C)
        if (param.length === 56 && (param.startsWith('G') || param.startsWith('C'))) {
          return StellarSdk.Address.fromString(param).toScVal();
        }
        // Otherwise treat as string
        return StellarSdk.nativeToScVal(param, {type: "string"});
      } else if (typeof param === 'number' || typeof param === 'bigint') {
        return StellarSdk.nativeToScVal(BigInt(param), {type: "i128"});
      } else if (typeof param === 'boolean') {
        return StellarSdk.nativeToScVal(param, {type: "bool"});
      }
      return StellarSdk.nativeToScVal(param);
    });
    
    const tx = new StellarSdk.TransactionBuilder(account, {
      fee: StellarSdk.BASE_FEE,
      networkPassphrase: CONFIG.networkPassphrase
    })
    .addOperation(contract.call(method, ...convertedParams))
    .setTimeout(30)
    .build();
    
    if (sendTx) {
      // Send real transaction for state-changing operations
      const preparedTx = await rpc.prepareTransaction(tx);
      preparedTx.sign(keypair);
      
      const result = await rpc.sendTransaction(preparedTx);
      
      if (result.status === 'SUCCESS') {
        return StellarSdk.scValToNative(result.returnValue);
      } else {
        throw new Error(`Transaction failed: ${result.status}`);
      }
    } else {
      // Simulate for view functions (read-only operations)
      const preparedTx = await rpc.prepareTransaction(tx);
      
      const result = await rpc.simulateTransaction(preparedTx);
      
      if (result.results && result.results.length > 0) {
        const returnValue = result.results[0].xdr;
        return StellarSdk.scValToNative(StellarSdk.xdr.ScVal.fromXDR(returnValue, 'base64'));
      } else {
        throw new Error(`Simulation failed: ${result.error || 'Unknown error'}`);
      }
    }
    
  } catch (error) {
    console.error(`Contract call error for ${method}:`, error);
    throw error;
  }
}

// Simulate contract interactions for demo (fallback)
async function simulateContractCall(method, params) {
  return new Promise(resolve => {
    setTimeout(() => resolve({ success: true }), 1000 + Math.random() * 2000);
  });
}

// Format number as currency
function formatCurrency(amount) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2
  }).format(amount);
}

// Format large numbers
function formatNumber(num) {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1) + 'M';
  } else if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'K';
  }
  return num.toLocaleString();
}

// Update all user balance displays
async function updateAllUserBalances() {
  const promises = ['vance', 'newsom', 'aoc', 'buttigieg', 'rubio', 'beshear'].map(candidate => 
    updateUserBalance(candidate)
  );
  await Promise.all(promises);
}

// Update user balance for a specific candidate
async function updateUserBalance(candidate) {
  try {
    const contractAddress = CONFIG.contracts[candidate];
    
    // Get user bet information from contract
    const userBet = await callContractMethod(contractAddress, 'get_user_bet', [
      keypair.publicKey()
    ]);
    
    let position = userPositions[candidate];
    if (userBet) {
      // Update position from contract data
      if (userBet.bet_on_true) {
        position.yesShares = userBet.shares;
      } else {
        position.noShares = userBet.shares;
      }
      position.claimed = userBet.claimed;
    }
    
    // Update balance displays
    document.getElementById(`${candidate}-yes-balance`).textContent = position.yesShares.toLocaleString();
    document.getElementById(`${candidate}-no-balance`).textContent = position.noShares.toLocaleString();
    
    // Get market state for claim button
    const marketState = await callContractMethod(contractAddress, 'get_market_state');
    const isSettled = marketState !== 'Undecided';
    
    // Update claim button state
    const claimBtn = document.getElementById(`${candidate}-claim-btn`);
    const hasShares = position.yesShares > 0 || position.noShares > 0;
    const hasWinningShares = isSettled && (
      (marketState === 'TrueOutcome' && position.yesShares > 0) ||
      (marketState === 'FalseOutcome' && position.noShares > 0)
    );
    
    if (hasWinningShares && !position.claimed) {
      claimBtn.disabled = false;
      claimBtn.textContent = 'Claim Winnings';
    } else if (position.claimed) {
      claimBtn.disabled = true;
      claimBtn.textContent = 'Claimed ‚úì';
    } else if (isSettled) {
      claimBtn.disabled = true;
      claimBtn.textContent = 'No Winnings';
    } else {
      claimBtn.disabled = true;
      claimBtn.textContent = hasShares ? 'Market Not Settled' : 'No Position';
    }
    
  } catch (error) {
    console.error(`Error updating user balance for ${candidate}:`, error);
    
    // Fallback to local position data
    const position = userPositions[candidate];
    document.getElementById(`${candidate}-yes-balance`).textContent = position.yesShares.toLocaleString();
    document.getElementById(`${candidate}-no-balance`).textContent = position.noShares.toLocaleString();
    
    const claimBtn = document.getElementById(`${candidate}-claim-btn`);
    claimBtn.disabled = true;
    claimBtn.textContent = 'Contract Error';
  }
}

// Claim winnings for a candidate
async function claimWinnings(candidate) {
  if (isLoading) return;
  
  try {
    isLoading = true;
    setLoadingState(candidate, true);
    
    showMessage(`Claiming winnings for ${getDisplayName(candidate)}...`, 'info');
    
    const contractAddress = CONFIG.contracts[candidate];
    
    // Call contract claim method
    await callContractMethod(contractAddress, 'claim', [
      keypair.publicKey()
    ], true); // Send real transaction for claim
    
    // Refresh data from contract
    await loadMarketData();
    await updateAllUserBalances();
    
    showMessage(
      `Successfully claimed winnings from ${getDisplayName(candidate)}!`, 
      'success'
    );
    
  } catch (error) {
    console.error('Claiming error:', error);
    showMessage(`Failed to claim winnings: ${error.message}`, 'error');
  } finally {
    isLoading = false;
    setLoadingState(candidate, false);
  }
}

// Demo function to settle a market (in real app this would be done by oracle)
async function settleMarket(candidate, outcome) {
  try {
    const contractAddress = CONFIG.contracts[candidate];
    
    // In real implementation, only the oracle can call this
    // For demo, we'll simulate the oracle call
    showMessage(`Settling market for ${getDisplayName(candidate)}...`, 'info');
    
    const oracleAddress = await callContractMethod(contractAddress, 'get_oracle');
    await callContractMethod(contractAddress, 'settle', [
      oracleAddress,
      outcome
    ], true); // Send real transaction for settlement
    
    // Refresh data
    await loadMarketData();
    await updateAllUserBalances();
    
    showMessage(`Market settled: ${getDisplayName(candidate)} ${outcome ? 'WON' : 'LOST'}`, 'success');
    
  } catch (error) {
    console.error('Settlement error:', error);
    showMessage(`Failed to settle market: ${error.message}`, 'error');
  }
}

console.log('üó≥Ô∏è SoroMarket initialized - 2028 Election Prediction Markets');
console.log('Features: LSMR bonding curves, fair pricing, Stellar blockchain');
console.log('Demo: Use settleMarket("candidate", true/false) to simulate market settlement');
</script>

<style>
:root {
  --bg1: #1a1b3e;
  --bg2: #080512;
  --glass: rgba(255,255,255,.1);
  --txt: #ffffff;
  --accent: #6366f1;
  --success: #10b981;
  --warning: #f59e0b;
  --error: #ef4444;
  --card-bg: rgba(255,255,255,.05);
  --border: rgba(255,255,255,.1);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  min-height: 100vh;
  background: linear-gradient(135deg, var(--bg1), var(--bg2));
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--txt);
  overflow-x: hidden;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem 1rem;
}

header {
  text-align: center;
  margin-bottom: 3rem;
}

h1 {
  font-size: 3rem;
  font-weight: 800;
  background: linear-gradient(90deg, var(--accent), #8b5cf6, #ec4899);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 1rem;
}

.subheading {
  font-size: 0.8rem;
  color: #6366f1;
  opacity: 0.8;
  margin-bottom: 1.5rem;
}

.subtitle {
  font-size: 1.2rem;
  opacity: 0.8;
  margin-bottom: 2rem;
}

.wallet-info {
  backdrop-filter: blur(10px);
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 15px;
  padding: 1rem 1.5rem;
  display: inline-block;
  margin-bottom: 2rem;
}

.markets-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 2rem;
  margin-bottom: 3rem;
}

.market-card {
  backdrop-filter: blur(10px);
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 2rem;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.market-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  border-color: var(--accent);
}

.market-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent), #8b5cf6, #ec4899);
}

.candidate-name {
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  text-align: center;
}

.candidate-party {
  text-align: center;
  opacity: 0.7;
  margin-bottom: 1.5rem;
  font-size: 0.9rem;
}

.market-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.stat {
  text-align: center;
}

.stat-label {
  font-size: 0.8rem;
  opacity: 0.7;
  margin-bottom: 0.3rem;
}

.stat-value {
  font-size: 1.2rem;
  font-weight: 600;
}

.probability {
  font-size: 2rem;
  font-weight: 800;
  color: var(--accent);
}

.betting-section {
  margin-top: 1.5rem;
}

.bet-inputs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1rem;
}

.bet-input-group {
  position: relative;
}

.bet-input-group input {
  width: 100%;
  padding: 0.75rem 1rem;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: rgba(255,255,255,0.05);
  color: var(--txt);
  font-size: 1rem;
  outline: none;
  transition: border-color 0.3s ease;
}

.bet-input-group input:focus {
  border-color: var(--accent);
}

.bet-input-group label {
  position: absolute;
  top: -0.5rem;
  left: 1rem;
  background: var(--bg1);
  padding: 0 0.5rem;
  font-size: 0.8rem;
  opacity: 0.8;
}

.bet-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.btn {
  padding: 1rem 1.5rem;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.btn:hover {
  transform: translateY(-2px);
}

.btn:active {
  transform: translateY(0);
}

.btn-yes {
  background: linear-gradient(45deg, var(--success), #059669);
  color: white;
}

.btn-yes:hover {
  box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
}

.btn-no {
  background: linear-gradient(45deg, var(--error), #dc2626);
  color: white;
}

.btn-no:hover {
  box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
}

.btn-claim {
  background: linear-gradient(45deg, var(--accent), #5b21b6);
  color: white;
  margin-top: 1rem;
  width: 100%;
}

.btn-claim:hover:not(:disabled) {
  box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
}

.btn-claim:disabled {
  background: rgba(255, 255, 255, 0.1);
  color: rgba(255, 255, 255, 0.4);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.loading {
  opacity: 0.6;
  pointer-events: none;
}

.message {
  text-align: center;
  padding: 1rem;
  border-radius: 10px;
  margin: 1rem 0;
  font-weight: 500;
}

.message.success {
  background: rgba(16, 185, 129, 0.2);
  border: 1px solid var(--success);
  color: var(--success);
}

.message.error {
  background: rgba(239, 68, 68, 0.2);
  border: 1px solid var(--error);
  color: var(--error);
}

.message.info {
  background: rgba(99, 102, 241, 0.2);
  border: 1px solid var(--accent);
  color: var(--accent);
}

.footer {
  text-align: center;
  margin-top: 3rem;
  padding: 2rem;
  opacity: 0.6;
  font-size: 0.9rem;
}

.footer a {
  color:#fff;
}

@media (max-width: 768px) {
  h1 {
    font-size: 2rem;
  }
  
  .markets-grid {
    grid-template-columns: 1fr;
  }
  
  .bet-inputs, .bet-buttons {
    grid-template-columns: 1fr;
  }
}

.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.hidden {
  display: none;
}

.user-position {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border);
}

.shares-balance {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1rem;
}

.balance-item {
  text-align: center;
  padding: 0.75rem;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 10px;
  border: 1px solid var(--border);
}

.balance-label {
  display: block;
  font-size: 0.8rem;
  opacity: 0.7;
  margin-bottom: 0.3rem;
}

.balance-value {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--accent);
}
</style>

</body>
</html>